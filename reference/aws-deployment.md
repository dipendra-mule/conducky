This is the context for setting up AWS deployment.

## Tech Stack

We will be using AWS to deploy our application. We want to use the free tier and the cheapest options available.

For the two services (frontend and backend), we will use ECS, Fargate, and also host the container images on ECR.

The database will be hosted on RDS in the free tier.

## Deployment and IAC Tech

We want to use Pulumi to deploy our infrastructure. We will use Pulumi Cloud to manage it. 

All of the necessary steps for deployment should be in a GitHub Actions workflow, with appropriate repository secrets.

## Other notes

We need the ability to run commands in both the frontend and backend containers, so make sure the ECS Exec is enabled.

Please make sure to create all the necessary IAM roles and policies for the deployment.

## Environment Variables, Secrets, and Configuration

### AWS Region
- The AWS region will be set as a repository secret or environment variable (e.g., `AWS_REGION`) in GitHub Actions and Pulumi. This allows flexible deployment to different regions.

### Backend Service
- **Required Environment Variables:**
  - `PORT` (default: 4000)
  - `DATABASE_URL` (Postgres connection string, will be generated by Pulumi and injected)
  - `JWT_SECRET` (must be set securely in GitHub repo secrets)
  - `FRONTEND_BASE_URL` (should be set to the deployed frontend URL, configurable via env/build var)
  - `SESSION_SECRET` (used for session middleware, should be set securely)
  - `CORS_ORIGIN` (should be set to the deployed frontend URL)

- **Prisma Migrations:**
  - Prisma migrations are run automatically in the backend container entrypoint (`entrypoint.sh`) using `npx prisma migrate deploy`.

### Frontend Service
- **Required Environment Variables:**
  - `NEXT_PUBLIC_API_URL` (should be set to the deployed backend URL, configurable via env/build var)

### Database (RDS)
- Postgres 15 instance will be created from scratch if not present.
- Credentials and connection string will be generated by Pulumi and injected as secrets into the backend service.

### Public-Facing Services
- Both frontend and backend will be deployed as public, internet-facing ECS services (with appropriate security groups and load balancers).
- No custom domain is required initially; endpoints will be accessible via AWS-generated URLs or IPs. Custom domains can be added later, and URLs should remain configurable via environment variables.

### Pulumi State and Secrets
- Pulumi state will be managed in Pulumi Cloud.
- Pulumi stack secrets (e.g., AWS credentials) can be managed in Pulumi Cloud, but application secrets (e.g., JWT_SECRET, SESSION_SECRET) should be managed as GitHub repo secrets for use in GitHub Actions.

### Open Questions/Assumptions
- Default AWS VPC/subnets will be used.
- No S3 buckets or other AWS resources are needed at this time.
- Failed deploys will be visible in GitHub Actions.
- All environment variables and secrets should be documented and updated here and in the plan file as needed.

## Pulumi Project Structure and Usage

- The Pulumi infrastructure-as-code will reside in the `infra/` directory at the project root.
- Pulumi will use TypeScript as the language for the stack.
- The default stack name will be `dev`.
- The Pulumi code and configuration will be designed to support both automated deployment via GitHub Actions and manual usage via `pulumi up` in the `infra/` directory for local testing and development.

TODO:
- Create policy for the user that is deploying the infrastructure.
- Assign the policy to the user.

## IAM User Setup for Pulumi Deployment

To securely deploy infrastructure with Pulumi, use a dedicated IAM user with the required permissions.

### 1. Configuring Pulumi to Use the IAM User

**Locally:**
- Obtain the IAM user's AWS Access Key ID and Secret Access Key.
- Set these as environment variables before running Pulumi commands:
  ```sh
  export AWS_ACCESS_KEY_ID=your-access-key-id
  export AWS_SECRET_ACCESS_KEY=your-secret-access-key
  export AWS_REGION=us-east-1  # or your chosen region
  ```
- Alternatively, configure a named AWS CLI profile:
  ```sh
  aws configure --profile conducky-pulumi
  export AWS_PROFILE=conducky-pulumi
  ```

**In GitHub Actions:**
- Add the IAM user's credentials as repository secrets:
  - `AWS_ACCESS_KEY_ID`
  - `AWS_SECRET_ACCESS_KEY`
  - `AWS_REGION`
- The GitHub Actions workflow will automatically use these secrets.

### 2. Updated Required Permissions/Policy for the IAM User

The IAM user needs permissions to manage ECS, ECR, RDS, IAM, EC2, ALB, and CloudWatch resources. For development/testing, you can use the managed policy `AdministratorAccess` (not recommended for production). For least privilege, use the following custom policy (now including `iam:TagRole` and `iam:UntagRole`):

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "ecs:*",
        "ecr:*",
        "rds:*",
        "iam:CreateRole",
        "iam:DeleteRole",
        "iam:AttachRolePolicy",
        "iam:DetachRolePolicy",
        "iam:PutRolePolicy",
        "iam:DeleteRolePolicy",
        "iam:PassRole",
        "iam:GetRole",
        "iam:ListRoles",
        "iam:TagRole",
        "iam:UntagRole",
        "ec2:*",
        "elasticloadbalancing:*",
        "cloudwatch:*",
        "logs:*"
      ],
      "Resource": "*"
    }
  ]
}
```
- This policy is broad for simplicity. For production, scope resources and actions more tightly.

### 3. Next Steps
- Attach the above policy (or `AdministratorAccess` for quick testing) to your IAM user.
- Set the credentials as described above for local and CI/CD use.
- Test with:
  ```sh
  pulumi up
  ```
- Pulumi will use the IAM user's permissions for all infrastructure operations.
